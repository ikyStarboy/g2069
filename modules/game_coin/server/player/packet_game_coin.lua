---
--- Generated by PluginCreator
--- game_coin handler
--- DateTime:2023-02-03
---

---@type WalletSystem
local WalletSystem = T(Lib, "WalletSystem")

---@type CoinExchangeConfig
local CoinExchangeConfig = T(Config, "CoinExchangeConfig")

local handles = T(Player, "PackageHandlers")
--function handles:Xxxxx(packet)
--end

--- 货币兑换
---@param packet any
function handles:C2SCoinExchange(packet)
    local player = self
    local id = packet.id

    local config = CoinExchangeConfig:getCfgById(id)
    if not config then
        player:sendPacket({
            pid = "S2CCoinExchange",
            id = id,
            stateCode = 1,
        })
    else
        local cube = WalletSystem:getCube(player)
        local cost = config.cost
        if cube >= cost then
            local coinNum = config.num
            local coinId = config.coin_id
            local reason = "coin_exchange_" .. coinId
            WalletSystem:payCube(player, 9900000 + id, cost, function(success)
                if success then
                    WalletSystem:addCoin(player, coinId, coinNum, reason)
                    player:sendPacket({
                        pid = "S2CCoinExchange",
                        id = id,
                        stateCode = 0,
                    })
                else
                    player:sendPacket({
                        pid = "S2CCoinExchange",
                        id = id,
                        stateCode = 2,
                    })
                end
            end, 1, reason) 
        end
    end
end
