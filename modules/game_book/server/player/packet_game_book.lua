---
--- Generated by PluginCreator
--- game_book handler
--- DateTime:2023-06-19
---

local handles = T(Player, "PackageHandlers")
---@type RewardHelper
local RewardHelper = T(Lib, "RewardHelper")
---@type BookRewardConfig
local BookRewardConfig = T(Config, "BookRewardConfig")
---@type BookInfoConfig
local BookInfoConfig = T(Config, "BookInfoConfig")
---@type InventorySystem
local InventorySystem = T(Lib, "InventorySystem")

function handles:C2SRequestDrawDownReward(packet)
    local bookRewardState = self:getBookRewardState()
    if bookRewardState[packet.rewardId] then
        return
    else
        local rewardCfg = BookRewardConfig:getCfgById(packet.rewardId)
        if rewardCfg then
            local haveBookNum = 0
            local allBook = BookInfoConfig:getAllCfgs()
            local inventoryType = Define.ITEM_INVENTORY_TYPE[Define.ITEM_TYPE.ABILITY]
            for _, data in pairs(allBook) do
                local ability = InventorySystem:getItemByItemId(self, inventoryType, data.abilityId)
                if ability then
                    haveBookNum = haveBookNum + 1
                end
            end
            if haveBookNum < rewardCfg.collectNum then
                return
            end

            if RewardHelper:gainBookRewards(self, rewardCfg.itemList, packet.rewardId) then
                bookRewardState[packet.rewardId] = true
                self:setBookRewardState(bookRewardState)
            end
        end
    end
end
